---
# Preamble

## Author
author:
  name: Верниковская Екатерина Андреевна
  degrees: Student
  orcid:
  email: 1132236136@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6
## Title
title: "Доклад"
subtitle: "NFS3 и NFS4. Сравнение"
license: "CC BY"
## Generic options
lang: ru-RU
number-sections: true
toc: true
toc-title: "Содержание"
toc-depth: 2
## Crossref customization
crossref:
  lof-title: "Список иллюстраций"
  lot-title: "Список таблиц"
  lol-title: "Листинги"
## Bibliography
bibliography:
  - bib/cite.bib
csl: _resources/csl/gost-r-7-0-5-2008-numeric.csl
## Formats
format:
### Pdf output format
  pdf:
    toc: true
    number-sections: true
    colorlinks: false
    toc-depth: 2
    lof: true # List of figures
    lot: true # List of tables
#### Document
    documentclass: scrreprt
    papersize: a4
    fontsize: 12pt
    linestretch: 1.5
#### Language
    babel-lang: russian
    babel-otherlangs: english
#### Biblatex
    cite-method: biblatex
    biblio-style: gost-numeric
    biblatexoptions:
      - backend=biber
      - langhook=extras
      - autolang=other*
#### Misc options
    csquotes: true
    indent: true
    header-includes: |
      \usepackage{indentfirst}
      \usepackage{float}
      \floatplacement{figure}{H}
      \usepackage[math,RM={Scale=0.94},SS={Scale=0.94},SScon={Scale=0.94},TT={Scale=MatchLowercase,FakeStretch=0.9},DefaultFeatures={Ligatures=Common}]{plex-otf}
### Docx output format
  docx:
    toc: true
    number-sections: true
    toc-depth: 2
---

# Вводная часть

**Актуальность темы и проблема:** повсеместное использование сетевых файловых систем сталкивается с проблемой выбора между проверенным, но устаревающим NFSv3 и современным, но более сложным NFSv4, что требует четкого понимания их различий для построения эффективной и безопасной IT-инфраструктуры

**Объект и предмет исследования:** сетевые файловые системы (Network File System — NFS) v3 и v4 

**Цель:** цель данного доклада – рассмотреть основные принципы протоколов NFSv3 и NFSv4 и провести сравнительный анализ для выявления их ключевых различий и определения оптимальных сценариев использования

**Задачи исследования:** изучить архитектурные особенности NFSv3 и NFSv4, провести их сравнительный анализ по ключевым параметрам и сформулировать практические рекомендации по выбору протокола

**Материалы и методы и инструменты исследования:** интернет-ресурсы, аналитика и практические навыки работы на своей операционной системе Linux (Ubuntu)

# Введение

В процессе своей работы сетевая инфраструктура постоянно обеспечивает доступ к данным, и выбор технологии для этого является фундаментальным для производительности и безопасности. Сетевая файловая система (NFS) долгие годы является основным решением для организации разделяемого доступа к файлам в UNIX- и Linux-средах. Однако со временем перед администраторами встаёт вопрос выбора между проверенной, но устаревающей третьей версией протокола и современной, но более сложной четвёртой. Этот выбор напрямую влияет на отказоустойчивость, скорость работы в локальных и глобальных сетях, а также на защищённость данных от несанкционированного доступа. Таким образом, понимание ключевых различий между NFSv3 и NFSv4 — критически важная задача для любого системного администратора, от которой зависит стабильность, эффективность и долгосрочная жизнеспособность всей ИТ-инфраструктуры.

## Что такое NFS?

**NFS(Network File System)** – это сетевая файловая система, позволяющая пользователям обращаться к файлам и каталогам, расположенным на удалённых компьютерах, как если бы эти файлы и каталоги были локальными. Главным преимуществом такой системы является то, что отдельно взятые рабочие станции могут использовать меньше собственного дискового пространства, так как совместно используемые данные хранятся на отдельной машине и доступны для других машин в сети. NFS – это клиент-серверное приложение. Т.е. в системе пользователя должен быть установлен NFS-клиент, а на компьютерах, которые предоставляют свое дисковое пространство – NFS-сервер. 

Основная цель сетевой файловой системы (NFS) — обеспечить прозрачный доступ к файлам, расположенным на удалённом сервере, как к локальным. Это позволяет пользователям и приложениям работать с сетевыми ресурсами, используя стандартные файловые операции (чтение, запись, удаление), без необходимости знать физическое расположение данных. NFS создаёт единое файловое пространство в многоплатформенной среде, обеспечивая совместимость между разными операционными системами и упрощая администрирование систем хранения данных. [@itglobal]

![NFS](image/nfs.png)

## История и развитие NFS

Протокол NFS (Network File System) был разработан компанией Sun Microsystems в 1984 году и стал одним из первых успешных решений для организации сетевого доступа к файлам. Первая версия применялась только для внутреннего использования Sun в эксперементальных целях. [@nets]

1. Первая публичная версия **NFSv2 появилась в 1989 году** и заложила основу технологии, используя протокол RPC (Remote Procedure Call) и работая поверх UDP. Несмотря на ограничения (например, размер файла до 2 ГБ и синхронную запись), NFSv2 быстро получила популярность благодаря открытости спецификаций и простоте реализации.

2. Следующим важным этапом стал выпуск **NFSv3 в 1995 году.** Эта версия устранила ключевые ограничения предшественника: поддержала 64-битные файлы, асинхронную запись для повышения производительности, TCP в качестве транспорта и сократила количество операций RPC за счет расширенных атрибутов файлов. NFSv3 стала "золотым стандартом" на долгие годы и до сих пор используется во многих системах.

3. Кардинальные изменения произошли с появлением **NFSv4 в 2000 году.** Протокол был полностью переработан: появилась stateful-архитектура (с отслеживанием состояния сессий), интегрированы функции монтирования и блокировок, устранена зависимость от внешних служб (portmapper, mountd).

4. Дальнейшее развитие продолжилось в версиях **NFSv4.1 (2010)** и **NFSv4.2 (2016).** NFSv4.1 представил поддержку параллельного доступа pNFS (Parallel NFS) для распределения нагрузки, а также сессии и улучшенную работу с кластерами. NFSv4.2 добавил такие функции, как клонирование файлов, пространственное резервирование (space reservation) и расширенную диагностику.

# Архитектура и работа NFS

Архитектура NFS основана на клиент-серверной модели, где сервер предоставляет доступ к своим файловым системам, а клиенты монтируют их в свое локальное дерево каталогов. Ключевым компонентом архитектуры является протокол **RPC (Remote Procedure Call)**, через который осуществляются все операции с файлами. [@redhat]

## Принцип работы

Процесс взаимодействия между клиентом и сервером, начиная с монтирования и заканчивая файловыми операциями, состоит из нескольких этапов:

1. Клиент инициирует запрос на монтирование удаленной файловой системы
2. Сервер аутентифицирует запрос и предоставляет доступ к экспортируемому каталогу
3. Клиент создает точку монтирования в локальном файловом дереве
4. Приложения работают с файлами через стандартные системные вызовы
5. NFS-клиент преобразует локальные запросы в RPC-вызовы к серверу
6. Сервер выполняет операции и возвращает результаты клиенту

## Основные компоненты архитектуры

Архитектура NFS включает в себя несколько ключевых компонентов, взаимодействующих между собой:

- NFS-сервер — экспортирует файловые системы
- NFS-клиент — монтирует удаленные ресурсы
- RPC-механизм — обеспечивает передачу запросов
- Демоны управления (mountd, statd, lockd) — дополнительные службы для NFSv3

![Принцип работы NFS](image/nfs_work.png)

# Протокол NFSv3

**NFSv3 (Network File System version 3)**, выпущенный в 1995 году, представляет собой значительное улучшение по сравнению с NFSv2 и долгое время являлся отраслевым стандартом для организации сетевого доступа к файловым системам.

## Ключевые архитектурные особенности NFSv3

Основа протокола — **stateless-архитектура,** где сервер не сохраняет состояние клиента между запросами. Это обеспечивает простоту реализации и отказоустойчивость — при перезагрузке сервера клиенты могут продолжить работу без потери сессии. Однако такая модель требует использования дополнительных служб: rpc.mountd для монтирования, rpc.statd и rpc.lockd для управления блокировками файлов. [@rfceditor]

## Принцип работы NFSv3

NFSv3 использует модель клиент-серверного взаимодействия на основе Remote Procedure Call (RPC). Каждая файловая операция (чтение, запись, получение атрибутов) преобразуется в соответствующий RPC-вызов, который передается на сервер для выполнения. Клиент инициирует запрос, а сервер возвращает результат выполнения операции.

Перед началом работы с файлами клиент должен смонтировать удаленную файловую систему:

- Клиент обращается к порту 111 (portmapper) для определения портов служб mountd и nfsd
- Устанавливается соединение с rpc.mountd, который проверяет права доступа и возвращает file handle корневого каталога
- Клиент создает точку монтирования в локальном файловом дереве, связывая ее с полученным file handle 

Каждый файл и каталог идентифицируется с помощью file handle - уникального числового идентификатора, который:

- Генерируется сервером при первом обращении к объекту
- Сохраняется клиентом для последующих операций с файлом
- Может стать невалидным при перезагрузке сервера или изменении файловой системы

Ключевые операции:
      
- Чтение/запись: Асинхронные операции с 64-битными смещениями
- Кэширование: Агрессивное кэширование атрибутов и данных на клиенте
- Блокировки: Управление через отдельный NLM (Network Lock Manager)

Обработка запросов:

1. Клиент отправляет RPC-запрос с file handle и параметрами операции
2. Сервер выполняет операцию и возвращает результат
3. При ошибках клиент повторяет запрос с экспоненциальной задержкой

![Принцип работы NFSv3](image/nfsv3.png)

# Протокол NFSv4

**NFSv4,** разработанный в 2000 году, представляет собой фундаментальную переработку протокола, устранившую многие ограничения предыдущих версий и предложившую комплексное решение для современных распределенных сред.

## Ключевые архитектурные особенности NFSv4

Основное нововведение — переход на **stateful-архитектуру,** где сервер сохраняет состояние клиентских сессий, открытых файлов и блокировок. Это позволило повысить надежность операций и упростить модель программирования. Все компоненты, включая монтирование файловых систем и управление блокировками, были интегрированы в основной протокол, что устранило зависимость от внешних служб (mountd, lockd, statd). [@merion]

![Stateful и stateless архитектура](image/state.png)

## Принцип работы NFSv4

NFSv4 использует усовершенствованную модель клиент-серверного взаимодействия на основе Stateful RPC (Remote Procedure Call). В отличие от NFSv3, протокол поддерживает состояние сессии между клиентом и сервером, что обеспечивает повышенную надежность операций и интегрированные службы безопасности. 

Перед началом работы с файлами клиент устанавливает защищенную сессию с сервером:

- Клиент подключается к стандартному порту 2049/tcp без использования portmapper
- Выполняется процедура аутентификации через RPCSEC_GSS (обычно Kerberos)
- Создается постоянная сессия с уникальным идентификатором клиента (Client ID)
- Клиент монтирует файловую систему через интегрированный протокол

Каждый файл и каталог идентифицируется с помощью строкового file handle, который:

- Имеет постоянную структуру на протяжении всего времени существования файла
- Сохраняет валидность при переименовании или перемещении файла
- Остается действительным после перезагрузки сервера

Ключевые операции:

- Чтение/запись: Поддержка компаундных операций (объединение нескольких запросов в один)
- Кэширование: Интеллектуальное кэширование с механизмом делегирования полномочий
- Блокировки: Интегрированное управление блокировками в основном протоколе

Обработка запросов:

1. Клиент устанавливает сессию и получает делегирования на файлы
2. Операции выполняются в рамках установленной сессии с отслеживанием состояния
3. При сетевых сбоях сессия автоматически восстанавливается с сохранением блокировок
4. Сервер может отзывать делегирования через callback-механизм при конфликтах доступа

![Принцип работы NFSv4](image/nfsv4.png)

# Практическое применение

Чтобы посмотреть, как работают NFSv3 и NFSv4 в реальной жизни была развернута тестовая среда, состоящая из двух узлов:

- Хост-система под управлением Ubuntu, выполняющая роль NFS-клиента
- Виртуальная машина (Ubuntu VM), функционирующая в качестве NFS-сервера

Первоначальным этапом конфигурации стало определение сетевых адресов обоих участников взаимодействия, поскольку установление NFS-соединения требует точной идентификации сетевых узлов. Для этого выполним команду ```ip a``` чтобы определить актуальные ip-адреса сервера и клиента. [@regcloud]

![IP-адрес клиента](image/1.png)

![IP-адрес сервера](image/2.png)

## Настройка СЕРВЕРА (Ubuntu VM)

Установим NFS-сервер с помощью ```sudo apt install nfs-kernel-server -y```

![Установка NFS-сервера](image/3.png)

Создадим тестовые каталоги: ```sudo mkdir -p /srv/nfs3 /srv/nfs4``` и ```sudo chown nobody:nogroup /srv/nfs3 /srv/nfs4```

![Создание тестовых каталогов](image/4.png)

Создадим тестовые файлы в этих каталогах: ```echo "Тестовый файл NFSv3" | sudo tee /srv/nfs3/test_file_v3.txt``` и ```echo "Тестовый файл NFSv4" | sudo tee /srv/nfs4/test_file_v4.txt```

![Создание тестовых файлов](image/5.png)

Далее настроим экспорт. Для этого откроим файл */etc/exports* и пропишем настройки для обеих версий протокола:

```
# NFSv3 экспорт
/srv/nfs3 192.168.56.1(rw,sync,no_subtree_check,no_root_squash)

# NFSv4 экспорт  
/srv/nfs4 192.168.56.1(rw,sync,no_subtree_check,no_root_squash)
```

![Настройка экспорта](image/6.png)

- /srv/nfs3 и /srv/nfs4 - каталоги на сервере, которые мы "расшариваем" для сети

- 192.168.56.1 - IP-адрес клиента, которому разрешен доступ

- rw - разрешение на чтение и запись (read/write)

- sync - синхронная запись, обеспечивает надежность операций

- no_subtree_check - отключает проверку поддеревьев, ускоряя работу

- no_root_squash - позволяет root-пользователю клиента сохранять права на сервере

Таким образом, мы разрешаем клиенту с IP 192.168.56.1 полноценно работать с указанными каталогами, используя либо NFSv3, либо NFSv4 протокол.

После сохранения файла применим настройки командой ```sudo exportfs -ra```

![Применение настроек экспорта](image/7.png)

Запустим сервер с помощью ```sudo systemctl start nfs-server``` и ```sudo systemctl enable nfs-server```

![Запуск сервера](image/8.png)

Проверим список экспортированных каталогов с помощью ```sudo exportfs -v```

![Список экспортированных каталогов](image/9.png)

## Настройка КЛИЕНТА (Ubuntu Host)

Установим NFS-клиент с помощью ```sudo apt install nfs-common -y```

![Установка NFS-клиента](image/10.png)

Создадим точки монтирования: ```sudo mkdir -p /mnt/nfs3 /mnt/nfs4```

![Создание точек монтирования](image/11.png)

Проверим доступность NFS-сервера: ```showmount -e 192.168.56.103```

![Проверка доступности NFS-сервера](image/12.png)

Выполним монтирование удалённой файловой системы с использованием протокола NFSv3 на клиенте: ```sudo mount -t nfs -o vers=3,nolock 192.168.56.103:/srv/nfs3 /mnt/nfs3```

![Монтирование NFSv3](image/13.png)

- mount - команда монтирования

- -t nfs - указываем тип файловой системы (NFS)

- -o vers=3,nolock - параметры:

	+ vers=3 - используем протокол NFSv3

	+ nolock - отключаем блокировки файлов (упрощает настройку)

- 192.168.56.103:/srv/nfs3 - адрес сервера и экспортируемый каталог

- /mnt/nfs3 - локальная точка монтирования на клиенте

Теперь файлы из серверного каталога /srv/nfs3 доступны в локальной папке /mnt/nfs3. Поверим это

![Проверка каталога /mnt/nfs3 (1)](image/14.png)

![Проверка каталога /mnt/nfs3 (2)](image/15.png)

Создадим файл с клиента в каталоге */mnt/nfs3*

![Создание файла с клиента в каталоге /mnt/nfs3](image/16.png)

Выполним монтирование удалённой файловой системы с использованием протокола NFSv4 на клиенте: ```sudo mount -t nfs -o vers=4 192.168.56.103:/srv/nfs4 /mnt/nfs4```

![Монтирование NFSv4](image/17.png)

- mount - команда монтирования

- -t nfs - указываем тип файловой системы (NFS)

- -o vers=4 - параметры:

	+ vers=4 - используем протокол NFSv4

- 192.168.56.103:/srv/nfs4 - адрес сервера и экспортируемый каталог

- /mnt/nfs4 - локальная точка монтирования на клиенте

Теперь файлы из серверного каталога /srv/nfs4 доступны в локальной папке /mnt/nfs4. Поверим это

![Проверка каталога /mnt/nfs4 (1)](image/18.png)

![Проверка каталога /mnt/nfs4 (2)](image/19.png)

Создадим файл с клиента в каталоге */mnt/nfs4*

![Создание файла с клиента в каталоге /mnt/nfs4](image/20.png)

## Анализ работы NFSv3 и NFSv4

На клиенте проверим порты сервера: ```rpcinfo -p 192.168.56.103 | grep -E "nfs|mount"```. Команда наглядно демонстрирует ключевое архитектурное различие - NFSv3 использует множество отдельных служб на разных портах, тогда как NFSv4 унифицирует все операции в одной службе на порту 2049.

![Порты сервера](image/21.png)

Посмотрим информацию о монтировании: ```mount | grep nfs```. Команда наглядно демонстрирует ключевое архитектурное различие - NFSv3 использует раздельные службы для монтирования и файловых операций, тогда как NFSv4 предоставляет единую интегрированную среду. 

![Информация о монтировании](image/22.png)

На сервере проверим, что создались файлы созданные на клиенте 

![Проверка файлов на сервере (1)](image/23.png)

![Проверка файлов на сервере (2)](image/24.png)

## Сравнение NFSv3 и NFSv4

\begin{table}[H]
\centering
\caption{Сравнение NFSv3 и NFSv4}
\label{table:table}
\begin{tabular}{|p{4cm}|p{4cm}|p{4cm}|}
\hline
\textbf{Параметр} & \textbf{NFSv3} & \textbf{NFSv4} \\ \hline
Архитектура & Stateless (без сохранения состояния) & Statefull (с сохранением состояния) \\ \hline
Протокол & TCP/UDP & Только TCP \\ \hline
Порты & Несколько портов (111, 2049+) & Единый порт 2049 \\ \hline
Блокировка файлов & Использует отдельный протокол & Встроена в основной протокол \\ \hline
Монтирование & Отдельный протокол (mountd) & Встроенное в протокол \\ \hline
Сложность настройки & Выше (несколько демонов) & Ниже (один демон) \\ \hline
Восстановение после сбоя & Клиенты должны переподключаться & Автоматическое восстановление \\ \hline
Совместимость & Широкая, работает с очень старыми системами & Требует поддержки NFSv4 на клиенте и сервере \\ \hline
\end{tabular}
\end{table}

# Выводы

Таким образом, сравнительный анализ NFSv3 и NFSv4 демонстрирует существенную эволюцию сетевых файловых систем. NFSv3 остается надежным решением для локальных сетей, где важны простота и минимальные задержки. Однако его ограничения в безопасности и работе с распределенными средами становятся все более критичными.

NFSv4 представляет собой качественно новый подход, предлагая комплексное решение современных задач. Интегрированная безопасность, надежные блокировки и оптимизация для работы с высокими задержками делают его стратегическим выбором для перспективных IT-инфраструктур.

Переход на NFSv4 требует понимания особенностей его stateful-архитектуры, но открывает значительные преимущества в надежности и безопасности. Для новых проектов NFSv4 является предпочтительным выбором, в то время как NFSv3 сохраняет актуальность для специфических задач, не требующих расширенной функциональности.

# Список литературы{.unnumbered}

::: {#refs}
::: 

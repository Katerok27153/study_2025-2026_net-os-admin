---
# Preamble

## Author
author:
  name: Верниковская Екатерина Андреевна
  degrees: DSc
  orcid: 0000-0002-0877-7063
  email: kulyabov-ds@rudn.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6
## Title
title: "Отчёт по лабораторной работе №15"
subtitle: "Дисциплина: Администрирование сетевых подсистем"
license: "CC BY"
## Generic options
lang: ru-RU
number-sections: true
toc: true
toc-title: "Содержание"
toc-depth: 2
## Crossref customization
crossref:
  lof-title: "Список иллюстраций"
  lot-title: "Список таблиц"
  lol-title: "Листинги"
## Bibliography
bibliography:
  - bib/cite.bib
csl: _resources/csl/gost-r-7-0-5-2008-numeric.csl
## Formats
format:
### Pdf output format
  pdf:
    toc: true
    number-sections: true
    colorlinks: false
    toc-depth: 2
    lof: true # List of figures
    lot: true # List of tables
#### Document
    documentclass: scrreprt
    papersize: a4
    fontsize: 12pt
    linestretch: 1.5
#### Language
    babel-lang: russian
    babel-otherlangs: english
#### Biblatex
    cite-method: biblatex
    biblio-style: gost-numeric
    biblatexoptions:
      - backend=biber
      - langhook=extras
      - autolang=other*
#### Misc options
    csquotes: true
    indent: true
    header-includes: |
      \usepackage{indentfirst}
      \usepackage{float}
      \floatplacement{figure}{H}
      \usepackage[math,RM={Scale=0.94},SS={Scale=0.94},SScon={Scale=0.94},TT={Scale=MatchLowercase,FakeStretch=0.9},DefaultFeatures={Ligatures=Common}]{plex-otf}
### Docx output format
  docx:
    toc: true
    number-sections: true
    toc-depth: 2
---

# Цель работы

Целью данной работы получить навыки по работе с журналами системных событий.

# Задание

1. Настроить сервер сетевого журналирования событий
2. Настроить клиент для передачи системных сообщений в сетевой журнал на сервере
3. Просмотреть журналы системных событий с помощью нескольких программ. При наличии сообщений о некорректной работе сервисов исправить ошибки в настройках соответствующих служб
4. Написать скрипты для Vagrant, фиксирующие действия по установке и настройке сетевого сервера журналирования

# Выполнение лабораторной работы

## Настройка сервера сетевого журнала

Загрузили нашу операционную систему и перешли в рабочий каталог с проектом: ```cd /var/tmp/eavernikovskaya/vagrant``` ([рис. @fig-001])

![Рабочий каталог с проектом](image/лаба15_1.png){#fig-001 width=70%}

Запустили виртуальную машину server: ```make server-up``` ([рис. @fig-002]) 

![Запуск виртуальной машины server](image/лаба15_2.png){#fig-002 width=70%}

Далее на виртуальной машине server вошли под созданным нами пользователем и открыли терминал. Перешли в режим суперпользователя: ```sudo -i``` ([рис. @fig-003])

![Переход в режим суперпользователя на server](image/лаба15_3.png){#fig-003 width=70%}

На сервере создали файл конфигурации сетевого хранения журналов ([рис. @fig-004]):

```cd /etc/rsyslog.d```

```touch netlog-server.conf```

![Создание файла /etc/rsyslog.d/netlog-server.conf на server](image/лаба15_4.png){#fig-004 width=70%}

В файле конфигурации */etc/rsyslog.d/netlog-server.conf* включили приём записей журнала по TCP-порту 514 ([рис. @fig-005]):

```
$ModLoad imtcp
$InputTCPServerRun 514
```

![Редактирование файла /etc/rsyslog.d/netlog-server.conf на server](image/лаба15_5.png){#fig-005 width=70%}

Перезапустили службу rsyslog на сервере: ```systemctl restart rsyslog``` ([рис. @fig-006])

![Перезапуск службы rsyslog на server](image/лаба15_6.png){#fig-006 width=70%}

Посмотрели, какие порты, связанные с rsyslog, прослушиваются: ```lsof | grep TCP``` ([рис. @fig-007])

![Просмотр прослушиваемых портов связанных с rsyslog](image/лаба15_7.png){#fig-007 width=70%}

На сервере настройте межсетевой экран для приёма сообщений по TCP-порту 514 ([рис. @fig-008]):

```firewall-cmd --add-port=514/tcp```

```firewall-cmd --add-port=514/tcp --permanent```

![Настройка межсетевого экрана для приёма сообщений по TCP-порту 514](image/лаба15_8.png){#fig-008 width=70%}

## Настройка клиента сетевого журнала

Запустили виртуальную машину client: ```make client-up``` ([рис. @fig-009]) 

![Запуск виртуальной машины client](image/лаба15_9.png){#fig-009 width=70%}

Далее на виртуальной машине client вошли под созданным нами пользователем и открыли терминал. Перешли в режим суперпользователя: ```sudo -i``` ([рис. @fig-010])

![Переход в режим суперпользователя на client](image/лаба15_10.png){#fig-010 width=70%}

На клиенте создали файл конфигурации сетевого хранения журналов ([рис. @fig-011]):

```cd /etc/rsyslog.d```

```touch netlog-client.conf```

![Создание файла /etc/rsyslog.d/netlog-client.conf на client](image/лаба15_11.png){#fig-011 width=70%}

На клиенте в файле конфигурации */etc/rsyslog.d/netlog-client.conf* включили
перенаправление сообщений журнала на 514 TCP-порт сервера: ```*.* @@server.eavernikovskaya.net:514``` ([рис. @fig-012])

![Редактирование файла /etc/rsyslog.d/netlog-client.conf на client](image/лаба15_12.png){#fig-012 width=70%}

Перезапустили службу rsyslog на клиенте: ```systemctl restart rsyslog``` ([рис. @fig-013])

![Перезапуск службы rsyslog на client](image/лаба15_13.png){#fig-013 width=70%}

## Просмотр журнала

На сервере посмотрели один из файлов журнала: ```tail -f /var/log/messages``` ([рис. @fig-014])

![Просмотр одного из файлов журнала на server](image/лаба15_14.png){#fig-014 width=70%}

На сервере под пользователем eavernikovskaya запустили графическую программу для просмотра журналов: ```gnome-system-monitor``` ([рис. @fig-015]), ([рис. @fig-016])

![Запуск графической программы для просмотра журналов](image/лаба15_15.png){#fig-015 width=70%}

![Просмотра журналов в графической программе gnome-system-monitor](image/лаба15_16.png){#fig-016 width=70%}

На сервере установили просмотрщик журналов системных сообщений lnav. Так как у меня не получилось сделать это с помощью команды ```dnf -y install lnav``` и так же у меня не установились его аналоги я постваила lnav вручную ([рис. @fig-017]), ([рис. @fig-018]), ([рис. @fig-019]), ([рис. @fig-020]), ([рис. @fig-021])

![Установка lnav на server (1)](image/лаба15_17.png){#fig-017 width=70%}

![Установка lnav на server (2)](image/лаба15_18.png){#fig-018 width=70%}

![Установка lnav на server (3)](image/лаба15_19.png){#fig-019 width=70%}

![Установка lnav на server (4)](image/лаба15_20.png){#fig-020 width=70%}

![Установка lnav на server (5)](image/лаба15_21.png){#fig-021 width=70%}

Далее посмотрели логи с помощью lnav: ```lnav``` ([рис. @fig-022]), ([рис. @fig-023])

![Запуск lnav на server](image/лаба15_22.png){#fig-022 width=70%}

![Просмотр общих логов на сервере](image/лаба15_23.png){#fig-023 width=70%}

Посмотрели логи на клиенте: ```tail -f /var/log/messages```. Все логи, имеющиеся на клиенте, также отображаются на сервере ([рис. @fig-024])

![Логи на сервере](image/лаба15_24.png){#fig-024 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

На виртуальной машине server перешли в каталог для внесения изменений в настройки внутреннего окружения */vagrant/provision/server/* и создали в нём каталог *netlog*, в который поместили в соответствующие подкаталоги конфигурационные файлы ([рис. @fig-025]):

```cd /vagrant/provision/server```

```mkdir -p /vagrant/provision/server/netlog/etc/rsyslog.d```

```cp -R /etc/rsyslog.d/netlog-server.conf /vagrant/provision/server/netlog/etc/rsyslog.d```

![Копирование конфигурационных файлов в каталог netlog на сервере](image/лаба15_25.png){#fig-025 width=70%}

В каталоге */vagrant/provision/server* создали исполняемый файл netlog.sh ([рис. @fig-026]): 

```cd /vagrant/provision/server```

```touch netlog.sh```

```chmod +x netlog.sh```

![Создание исполняемого файла netlog.sh на сервере](image/лаба15_26.png){#fig-026 width=70%}

Открыв его на редактирование, прописали в нём следующий скрипт ([рис. @fig-027]):

```
#!/bin/bash
echo "Provisioning script $0"
echo "Copy configuration files"
cp -R /vagrant/provision/server/netlog/etc/* /etc
restorecon -vR /etc
echo "Configure firewall"
firewall-cmd --add-port=514/tcp
firewall-cmd --add-port=514/tcp --permanent
echo "Start rsyslog service"
systemctl restart rsyslog
```

![Редактирование файла netlog.sh на сервере](image/лаба15_27.png){#fig-027 width=70%}

На виртуальной машине client перешли в каталог для внесения изменений в настройки внутреннего окружения */vagrant/provision/client/* и создали в нём каталог *netlog*, в который поместили в соответствующие подкаталоги конфигурационные файлы ([рис. @fig-028]):

```cd /vagrant/provision/client```

```mkdir -p /vagrant/provision/client/netlog/etc/rsyslog.d```

```cp -R /etc/rsyslog.d/netlog-client.conf /vagrant/provision/client/netlog/etc/rsyslog.d/```

![Копирование конфигурационных файлов в каталог netlog на клиенте](image/лаба15_28.png){#fig-028 width=70%}

В каталоге */vagrant/provision/client/* создали исполняемый файл netlog.sh ([рис. @fig-029]): 

```cd /vagrant/provision/client```

```touch netlog.sh```

```chmod +x netlog.sh```

![Создание исполняемого файла netlog.sh на клиенте](image/лаба15_29.png){#fig-029 width=70%}

Открыв его на редактирование, прописали в нём следующий скрипт ([рис. @fig-030]):

```
#!/bin/bash
echo "Provisioning script $0"
echo "Install needed packages"
dnf -y install lnav
echo "Copy configuration files"
cp -R /vagrant/provision/client/netlog/etc/* /etc
restorecon -vR /etc
echo "Start rsyslog service"
systemctl restart rsyslog
```

![Редактирование файла netlog.sh на клиенте](image/лаба15_30.png){#fig-030 width=70%}

Для отработки созданных скриптов во время загрузки виртуальных машин server и client в конфигурационном файле Vagrantfile необходимо добавить в соответствующих разделах конфигураций для сервера и клиента ([рис. @fig-031]), ([рис. @fig-032]):

```
server.vm.provision "server netlog",
	type: "shell",
	preserve_order: true,
	path: "provision/server/netlog.sh"
client.vm.provision "client netlog",
	type: "shell",
	preserve_order: true,
	path: "provision/client/netlog.sh"
```

![Редактирование файла Vagrantfile (1)](image/лаба15_31.png){#fig-031 width=70%}

![Редактирование файла Vagrantfile (2)](image/лаба15_32.png){#fig-032 width=70%}

После этого можно выключать виртуальные машины server и client: ```make server-halt``` и ```make client-halt``` ([рис. @fig-033])

![Выклчение виртуальных машин server и client](image/лаба15_33.png){#fig-033 width=70%}

## Контрольные вопросы + ответы

1. Какой модуль rsyslog вы должны использовать для приёма сообщений от journald?

Для приёма сообщений от journald в rsyslog используется модуль imjournal

2. Как называется устаревший модуль, который можно использовать для включения приёма сообщений журнала в rsyslog?

Устаревший модуль для приема сообщений журнала в rsyslog - imuxsock (или imuxsock_legacy).

3. Чтобы убедиться, что устаревший метод приёма сообщений из journald в rsyslog не используется, какой дополнительный параметр следует использовать?

Для предотвращения использования устаревшего метода можно использовать параметр SystemMaxUseForward=no в файле */etc/systemd/journald.conf*

4. В каком конфигурационном файле содержатся настройки, которые позволяют вам настраивать работу журнала?

Настройки, позволяющие настроить работу журнала, содержатся в файле */etc/systemd/journald.conf*

5. Каким параметром управляется пересылка сообщений из journald в rsyslog?

Для управления пересылкой сообщений из journald в rsyslog используется параметр ForwardToSyslog=yes в файле */etc/systemd/journald.conf*

6. Какой модуль rsyslog вы можете использовать для включения сообщений из файла журнала, не созданного rsyslog?

Для включения сообщений из файла журнала, не созданного rsyslog, используется модуль imfile

7. Какой модуль rsyslog вам нужно использовать для пересылки сообщений в базу данных MariaDB?

Для пересылки сообщений в базу данных MariaDB используется модуль ommysql или ommysqlps

8. Какие две строки вам нужно включить в rsyslog.conf, чтобы позволить текущему журнальному серверу получать сообщения через TCP?

Добавьте следующие строки в rsyslog.conf:

```
$ModLoad imtcp
$InputTCPServerRun 514
```

9. Как настроить локальный брандмауэр, чтобы разрешить приём сообщений журнала через порт TCP 514?

Используйте команды для открытия порта:

```
sudo firewall-cmd --permanent --add-port=514/tcp
sudo firewall-cmd --reload
```

Или:

```
sudo iptables -A INPUT -p tcp --dport 514 -j ACCEPT
sudo service iptables save
sudo service iptables restart
```

# Выводы

В ходе выполнения лабораторной работы №15 мы получили навыки по работе с журналами системных событий.

# Список литературы

1. [Лаборатораня работа №15](https://esystem.rudn.ru/pluginfile.php/2854790/mod_resource/content/8/015-netlog.pdf)
